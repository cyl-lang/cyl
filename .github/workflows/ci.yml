name: CI

on:
  push:
    branches: [master, development]
  pull_request:
    branches: [master, development]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Ubuntu-only job for cost efficiency and reliability
  test:
    name: Test & Build
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Robust LLVM 14 installation (more stable than 15)
      - name: Install LLVM 14
        run: |
          # Use Ubuntu's default LLVM 14 packages
          sudo apt-get update
          sudo apt-get install -y \
            llvm-14 \
            llvm-14-dev \
            clang-14 \
            libclang-14-dev \
            libclang-common-14-dev

          # Set environment variables for llvm-sys
          echo "LLVM_SYS_140_PREFIX=/usr/lib/llvm-14" >> $GITHUB_ENV
          echo "LLVM_CONFIG_PATH=/usr/bin/llvm-config-14" >> $GITHUB_ENV
          echo "LIBCLANG_PATH=/usr/lib/llvm-14/lib" >> $GITHUB_ENV

          # Verify installation
          echo "LLVM Config: $(/usr/bin/llvm-config-14 --version)"
          echo "LLVM Prefix: $(/usr/bin/llvm-config-14 --prefix)"
          echo "LLVM Libs: $(/usr/bin/llvm-config-14 --libdir)"
          echo "LibClang Path: /usr/lib/llvm-14/lib"
          ls -la /usr/lib/llvm-14/lib/ | grep -E "libLLVM|libclang" | head -5

          # Create symlinks if needed for better detection
          sudo ln -sf /usr/bin/llvm-config-14 /usr/local/bin/llvm-config || true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            compiler/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      # Build and test
      - name: Build and test Rust
        working-directory: compiler
        env:
          LLVM_SYS_140_PREFIX: /usr/lib/llvm-14
          LLVM_CONFIG_PATH: /usr/bin/llvm-config-14
          LIBCLANG_PATH: /usr/lib/llvm-14/lib
        run: |
          echo "Environment check:"
          env | grep -i llvm
          echo "LLVM Config test:"
          /usr/bin/llvm-config-14 --version
          echo "LibClang verification:"
          ls -la /usr/lib/llvm-14/lib/libclang* | head -3
          echo "Starting cargo build..."
          cargo build --release
          echo "Starting tests..."
          cargo test
          echo "Starting clippy..."
          cargo clippy -- -D warnings

      # TypeScript tests
      - name: Setup Node.js and test
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: TypeScript tests
        run: |
          npm ci
          npm test
